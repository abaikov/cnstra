<!DOCTYPE html>
<html>
<head>
    <title>Test Late-Joining Apps</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976d2; }
        #apps { margin: 20px 0; }
        .app { padding: 10px; margin: 5px 0; background: #e3f2fd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test Late-Joining Apps</h1>
    
    <div>
        <button onclick="connectToServer()">Connect to Server</button>
        <button onclick="simulateAppAdded()">Simulate App Added</button>
        <button onclick="simulateAppsActive()">Simulate Apps Active</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="status">Not connected</div>
    
    <div id="apps">
        <h3>Connected Apps:</h3>
        <div id="appsList">No apps</div>
    </div>

    <div id="logs"></div>

    <script>
        let ws = null;
        let connectedApps = [];

        function log(message, type = 'log') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateAppsList() {
            const appsListDiv = document.getElementById('appsList');
            if (connectedApps.length === 0) {
                appsListDiv.innerHTML = 'No apps';
            } else {
                appsListDiv.innerHTML = connectedApps.map(app => 
                    `<div class="app">${app.appName} (${app.appId})</div>`
                ).join('');
            }
        }

        function connectToServer() {
            if (ws) {
                ws.close();
            }

            const url = 'ws://localhost:8080';
            ws = new WebSocket(url);

            ws.onopen = () => {
                log('Connected to server', 'success');
                document.getElementById('status').textContent = 'Connected';
                
                // Identify as DevTools client
                ws.send(JSON.stringify({ type: 'devtools-client-connect' }));
                
                // Request apps list
                ws.send(JSON.stringify({ type: 'apps:list' }));
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    log(`Received: ${message.type}`, 'log');
                    
                    if (message.type === 'apps:list' || message.type === 'apps:active') {
                        connectedApps = message.apps || [];
                        updateAppsList();
                        log(`Updated apps list: ${connectedApps.length} apps`, 'success');
                    } else if (message.type === 'app:added') {
                        const newApp = message.app;
                        connectedApps.push(newApp);
                        updateAppsList();
                        log(`Added new app: ${newApp.appName} (${newApp.appId})`, 'success');
                    }
                } catch (error) {
                    log(`Error parsing message: ${error.message}`, 'error');
                }
            };

            ws.onclose = () => {
                log('Disconnected from server', 'error');
                document.getElementById('status').textContent = 'Disconnected';
            };

            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
        }

        function simulateAppAdded() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected to server', 'error');
                return;
            }

            // Simulate server sending app:added message
            const newApp = {
                appId: 'test-app-' + Date.now(),
                appName: 'Test App ' + new Date().toLocaleTimeString(),
                version: '1.0.0',
                firstSeenAt: Date.now(),
                lastSeenAt: Date.now()
            };

            const message = {
                type: 'app:added',
                app: newApp
            };

            // Simulate receiving the message
            ws.onmessage({ data: JSON.stringify(message) });
        }

        function simulateAppsActive() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected to server', 'error');
                return;
            }

            // Simulate server sending apps:active message
            const apps = [
                {
                    appId: 'existing-app',
                    appName: 'Existing App',
                    version: '1.0.0',
                    firstSeenAt: Date.now() - 10000,
                    lastSeenAt: Date.now() - 5000
                },
                {
                    appId: 'new-app',
                    appName: 'New App',
                    version: '2.0.0',
                    firstSeenAt: Date.now(),
                    lastSeenAt: Date.now()
                }
            ];

            const message = {
                type: 'apps:active',
                apps: apps
            };

            // Simulate receiving the message
            ws.onmessage({ data: JSON.stringify(message) });
        }

        // Auto-connect on page load
        window.onload = () => {
            log('Page loaded. Click "Connect to Server" to start testing.', 'log');
        };
    </script>
</body>
</html>
